<!doctype html>
<html lang="en">

<!--
    @file:      index.html
    @brief:     L-System Frontend
    @author:    Raphael Pour <turtle@raphaelpour.de>
    @license:   (C) 2018 Raphael Pour LGPL
-->

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/png" href="logo.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
        crossorigin="anonymous">

    <!-- Custom CSS to make  UI more awesome-->
    <link rel="stylesheet" href="style.css">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>
    <!-- development version, includes helpful console warnings -->
    <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
    <!--<script src="https://unpkg.com/vue@2.3.3/dist/vue.js"></script>-->
    <script src="https://unpkg.com/vue"></script>

    <!-- production version, optimized for size and speed -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script>-->


    <!-- Include our Bounds Class-->
    <script src="bounds.js"></script>

    <!-- Include our Turtle Class-->
    <script src="turtle.js"></script>

    <!-- Include our Silent Turtle Class-->
    <script src="silent_turtle.js"></script>

    <!-- Include our LSystem Class-->
    <script src="lsystem.js"></script>


    <title>L-Systems</title>
</head>

<body class="text-center">

    <div class='jumbotron' style='padding:10px'>
        <h1>
            <a href='index.html'><img src='logo.png' style='vertical-align:center;margin-right:40px'></a>L-Systems</h1>
        <p><em>~Fractals, powered by formal languages~</em></p>
    </div>

    <div class='container' id='lSystemsApp'>

        <div class='row'>
            <div class="col-md-2" style='text-align:left;line-height:40px;'>
                <div class="form-group">
                    <button type="button" class="btn btn-warning" id="debugCanvasTemplateButton" v-on:click="setDebugCanvasTemplate">Canvas
                        Debug</button>
                    <button type="button" class="btn btn-warning" id="debugCanvasTemplateButton2" v-on:click="setDebugCanvas2Template">Canvas
                        Debug2</button>
                    <button type="button" class="btn btn-primary" id="kochTemplateButton" v-on:click="setKochTemplate">Koch
                        Curve</button>
                    <button type="button" class="btn btn-primary" id="kochSnowflakeTemplateButton" v-on:click="setKochSnowflakeTemplate">Koch
                        Snowflake</button>
                    <button type="button" class="btn btn-primary" id="hilbertTemplateButton" v-on:click="setHilbertTemplate">Hilbert
                        Curve</button>
                    <button type="button" class="btn btn-primary" id="sierpinskiTriangleTemplateButton" v-on:click="setSierpinskiTriangleTemplate">Sierpinski
                        Triangle</button>
                    <button type="button" class="btn btn-primary" id="dragonCurveTemplateButton" v-on:click="setDragonCurveTemplate">Dragon
                        Curve</button>
                    <button type="button" class="btn btn-primary" id="plantTemplateButton" v-on:click="setPlantTemplate">Plant</button>
                    <button type="button" class="btn btn-primary" id="lstarTemplateButton" v-on:click="setLStarTemplate">LStar</button>
                </div>
            </div>
            <div class='col-md-5'>
                <div id="accordion" style='padding-bottom:25px;'>
                    <div class="card" id="card1">
                        <div class="card-header">
                            <a class="card-link" data-toggle="collapse" href="#collapse1">L-System Language</a>
                        </div>
                        <div id="collapse1" class="collapse show" data-parent="#accordion">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="control-label" for="variables">Variables (V):</label>
                                    <input type="text" class="form-control" v-model="V" v-on:keyup="autoGenerate" id="variables">
                                </div>

                                <div class="form-group">
                                    <label class="control-label" for="alphabet">Alphabet (&Sigma;):</label>
                                    <input type="text" class="form-control" v-model="E" v-on:keyup="autoGenerate" id="alphabet">
                                </div>

                                <div class="form-group">
                                    <label class="control-label" for="axiom">Axiom (&omega;):</label>
                                    <input type="text" class="form-control" v-model="A" v-on:keyup="autoGenerate" id="axiom">
                                </div>

                                <div class="form-group">
                                    <label class="control-label" for="rules">Rules (P):</label>
                                    <textarea class="form-control" rows="3" v-model="P" v-on:keyup="autoGenerate" id="rules"></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-danger" id="clearButton" v-on:click="clear">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" id="card2">
                        <div class="card-header">
                            <a class="collapsed card-link" data-toggle="collapse" href="#collapse2">Turtle
                                Graphic Settings</a>
                        </div>
                        <div id="collapse2" class="collapse hidden" data-parent="#accordion">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="control-label" for="iterations">Iterations:</label>
                                    <input type="range" value="1" step="1" min="1" max="20" class="form-control"
                                        v-model="n" v-on:change="autoGenerate" id="iterations">
                                    {{ n }}
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="alpha">Alpha (&alpha;):</label>
                                    <input type="range" start="0" min="0" max="360" step="0.1" class="form-control"
                                        v-model="alpha" v-on:change="autoGenerate" id="alpha">
                                    {{alpha}}
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="startAngleId">Start-Angle (&beta;):</label>
                                    <input type="range" start="0" min="0" max="360" step="0.1" class="form-control"
                                        v-model="startAngle" v-on:change="autoGenerate" id="startAngleId">
                                    {{startAngle}}
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="autoGenId">Auto Generate</label>
                                    <input type="checkbox" class="form-control" v-model="autoGen" id="autoGenId">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="card3">
                        <div class="card-header">
                            <a class="collapsed card-link" data-toggle="collapse" href="#collapse22">Turtle
                                Command Reference</a>
                        </div>
                        <div id="collapse22" class="collapse hidden" data-parent="#accordion">
                            <div class="card-body">
                                <table class="table" style='text-align:left'>
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Turtle Command</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style='font-family:monospace;'>f,F,G</td>
                                            <td>Go one step forward and draw a line</td>
                                        </tr>
                                        <tr>
                                            <td style='font-family:monospace;'>+</td>
                                            <td>Turn right by &alpha;&deg;</td>
                                        </tr>
                                        <tr>
                                            <td style='font-family:monospace;'>-</td>
                                            <td>Turn left by &alpha;&deg;</td>
                                        </tr>
                                        <tr>
                                            <td style='font-family:monospace;'>|</td>
                                            <td>Turn around (+180&deg;)</td>
                                        </tr>
                                        <tr>
                                            <td style='font-family:monospace;'>[</td>
                                            <td>Save current Turtle state (Position and Orientation)</td>
                                        </tr>
                                        <tr>
                                            <td style='font-family:monospace;'>]</td>
                                            <td>Restore last saved Turtle state</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="card4">
                        <div class="card-header">
                            <a class="collapsed card-link" data-toggle="collapse" href="#collapse4">Debugging</a>
                        </div>
                        <div id="collapse4" class="collapse hidden" data-parent="#accordion">
                            <div class="card-body">
                                <div class="form-group row">
                                    <label class="control-label col-sm-4" for="xoffsetId">X-Offset:</label>
                                    <input type="range" min="-200" max="200" value="0" step="0.01" class="form-control col-sm-4 slider"
                                        v-model="xoffsetUI" v-on:change="generate" id="xoffsetId">
                                    <div class="col-sm-2">{{ xoffsetUI}}</div>
                                </div>
                                <div class="form-group row">
                                    <label class="control-label col-sm-4" for="yoffsetId">Y-Offset:</label>
                                    <input type="range" min="-200" max="200" value="0" step="0.01" class="form-control col-sm-4 slider"
                                        v-model="yoffsetUI" v-on:change="generate" id="yoffsetId">
                                    <div class="col-sm-2">{{ yoffsetUI}}</div>
                                </div>
                                <div class="form-group row">
                                    <label class="control-label col-sm-4" for="zoomId">Zoom:</label>
                                    <input type="range" min="-10" max="10" value="1" step="1" class="form-control col-sm-4 slider"
                                        v-model="zoomUI" v-on:change="generate" id="zoomId">
                                    <div class="col-sm-2">{{ zoomUI}}</div>
                                </div>

                                <div class="form-group row">
                                    <label class="control-label col-sm-4" for="preProcessingVisibilityId">Pre-Processing
                                        Output:</label>
                                    <input type="checkbox" class="form-control col-sm-1" v-model="preProcessingVisible"
                                        v-on:change="togglePreProcessingCanvas" id="preProcessingVisibilityId">
                                </div>
                                <div class="form-group row">
                                    <label class="control-label col-sm-4" for="showCanvasDebugId">Show Canvas Debug
                                        Graphics</label>
                                    <input type="checkbox" class="form-control col-sm-1" v-model="showCanvasDebug" id="showCanvasDebugId">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="card5">
                        <div class="card-header">
                            <a class="collapsed card-link" data-toggle="collapse" href="#collapse5">Language
                                Output</a>
                        </div>
                        <div id="collapse5" class="collapse hidden" data-parent="#accordion">
                            <div class="card-body">
                                <div class="form-group">
                                    Output:
                                    <textarea readonly class="form-control" rows="5" id="output">{{ out }}</textarea>
                                    Silent-Turtle Output:
                                    <textarea readonly class="form-control" rows="5" id="output2">{{ silentTurtleOut }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" id="card6">
                        <div class="card-header">
                            <a class="collapsed card-link" data-toggle="collapse" href="#collapse6">Fractal
                                Properties</a>
                        </div>
                        <div id="collapse6" class="collapse hidden" data-parent="#accordion">
                            <div class="card-body">
                                
                                <table class="table" style='text-align:left'>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Self-Similarity Dimension</td>
                                            <td>{{ selfSimilarityDim }}</td>
                                        </tr>
                                        <tr>
                                            <td>Copies</td>
                                            <td>{{ selfSimilarityCopies }}</td>
                                        </tr>
                                        <tr>
                                            <td>Scale Factor</td>
                                            <td>{{ selfSimilarityScaleFactor }}</td>
                                        </tr>
                                        <tr>
                                            <td>Box Dimension</td>
                                            <td>{{ boxDimension }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-success" id="calcDimensionButton" v-on:click="calcDimension">Calc
                                    Self-Similarity Dimension</button>
                                <button type="button" class="btn btn-success" disabled id="calcBoxDimensionButton"
                                    v-on:click="calcBoxDimension">Calc
                                    Box Dimension (Coming soon)</button>
                                    
                            </div>
                        </div>
                    </div
                </div>
                <div v-html="log"> </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" id="generateButton" v-on:click="generate">Generate</button>
                    <button type="button" class="btn btn-success" id="generateButton2" v-on:click="generateWithSilentTurtle">Silent
                        Turtle</button>

                    <p style="color:grey"><em>{{ durationOut }}</em></p>

                </div>
            </div>
            <div class='col-md-*' style=''>
                <canvas id='screenPostProcessing' style="border: 2px solid black;display:none" width='512' height='512'></canvas>
            </div>
            <div class='col-md-3' style=''>
                <canvas id='screen' style='border:2px solid black' width='512' height='512'></canvas>
            </div>
        </div>
    </div>
    <script>
        // Post Content Scripts

        var app = new Vue({
            el: '#lSystemsApp',
            data: {
                V: "",
                P: "",
                E: "",
                A: "",
                n: 4,
                alpha: 45.0,
                startAngle: 0.0,
                angleOffset: 90.0,
                out: "",
                log: "",
                xoffsetUI: 0,
                yoffsetUI: 0,
                zoomUI: 0,
                startTime: null,
                endTime: null,
                durationOut: "",
                silentTurtleOut: "",
                showCanvasDebug: false,
                ctx: null,
                autoGen: true,
                preProcesssingCtx: null,
                preProcessingVisible: false,
                selfSimilarityDim: 0,
                selfSimilarityCopies: 0,
                selfSimilarityScaleFactor: 0,
                boxDimension: 0
            },
            created: function () {
                //this.setLStarTemplate(); // --> Default

                // Disable AutoGenerate inside the constructor
                // to avoid Canvas Context Reference Errors
                // This is maybe caused by the execution order of the browser
                var temp = this.autoGen;
                this.autoGen = false;
                this.setKochSnowflakeTemplate();
                this.autoGen = temp;
            },
            methods: {

                clear: function () {
                    this.V = "";
                    this.P = "";
                    this.E = "";
                    this.A = "";
                },

                setDebugCanvasTemplate: function () {
                    this.V = "F";
                    this.P = "F=F+F";
                    this.E = "+-";
                    this.A = "F";
                    this.alpha = 1.0;
                    this.startAngle = 0.0;
                    this.n = 10;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setDebugCanvas2Template: function () {
                    this.V = "F";
                    this.P = "F=FF";
                    this.E = "+";
                    this.A = "+FFFF";
                    this.alpha = 45.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setLStarTemplate: function () {
                    this.V = "AF";
                    this.P = "A=AAffff--f--fff++ff--f--fff+AA-";
                    this.E = "+-f";
                    this.A = "FA";
                    this.alpha = 45.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setKochTemplate: function () {
                    this.V = "F";
                    this.P = "F=F+F--F+F";
                    this.E = "+-";
                    this.A = "F";
                    this.alpha = 60.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setKochSnowflakeTemplate: function () {
                    this.V = "F";
                    this.P = "F=F+F--F+F";
                    this.E = "+-";
                    this.A = "F--F--F";
                    this.alpha = 60.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setDragonCurveTemplate: function () {
                    this.V = "FG";
                    this.P = "F=F+Gf+\nG=-fF-G";
                    this.E = "+-f";
                    this.A = "fF";
                    this.alpha = 90.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setHilbertTemplate: function () {
                    this.V = "AB";
                    this.P = "A=-Bf+AfA+fB-\nB=+Af-BfB-fA+";
                    this.E = "+-f";
                    this.A = "B";
                    this.alpha = 90.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setSierpinskiTriangleTemplate: function () {
                    this.V = "FG";
                    this.P = "F=G-F-G\nG=F+G+F";
                    this.E = "+-";
                    this.A = "F";
                    this.alpha = 60.0;
                    this.startAngle = 0.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },
                setPlantTemplate: function () {
                    this.V = "FG";
                    this.P = "G=F+[[G]-G]-F[-FG]+F\nF=FF";
                    this.E = "+-[]";
                    this.A = "G";
                    this.alpha = 25.0;
                    this.startAngle = 270.0;
                    this.n = 3;
                    this.out = "";
                    this.log = "";
                    this.autoGenerate();
                },

                togglePreProcessingCanvas() {

                    if (this.preProcessingVisible)
                        $('#screenPostProcessing').show();
                    else
                        $('#screenPostProcessing').hide();

                },

                autoGenerate: function () {
                    if (this.autoGen)
                        this.generate();
                },

                generate: function () {

                    var l = new LSystem();
                    var output = "";
                    this.log = "";
                    try {
                        l.V = this.V;
                        l.E = this.E;
                        l.Axiom = this.A;
                        l.P = this.P;
                        l.n = this.n;
                        l.generate()
                        this.out = l.out;
                    } catch (error) {
                        this.log = "<div class='alert alert-danger'>[LSystem]: " + error + "</div>";
                        return;
                    }

                    // Draw it.
                    //try {
                    var t = new Turtle(this.ctx.canvas.width, this.ctx.canvas.height, this.alpha, this.n, 100.0, this.showCanvasDebug);

                    t.angleOffset = parseFloat(this.angleOffset) + parseFloat(this.startAngle);
                    //console.log(this.angleOffset + "/" + this.startAngle + "/" + t.angleOffset);
                    t.xOffsetUI = this.xoffsetUI;
                    t.yOffsetUI = this.yoffsetUI;
                    t.zoomUI = this.zoomUI;
                    t.clear();

                    this.startTime = performance.now();
                    t.computeWord(l.out);
                    this.endTime = performance.now();

                    var duration = (this.endTime - this.startTime) / 1000.0;
                    this.durationOut = "Rendered within " + duration + "s"

                    this.ctx.drawImage(t.finalCanvas, 0, 0);
                    this.preProcesssingCtx.drawImage(t.preProcessingCanvas, 0, 0);


                    /*} catch (error) {
                        this.log = "<div class='alert alert-danger'>[Turtle]: " + error + "</div>";
                    }*/

                },

                generateWithSilentTurtle: function () {
                    var l = new LSystem();
                    var output = "";
                    this.log = "";
                    try {
                        l.V = this.V;
                        l.E = this.E;
                        l.Axiom = this.A;
                        l.P = this.P;
                        l.n = this.n;
                        l.generate()
                        this.out = l.out;
                    } catch (error) {
                        this.log = "<div class='alert alert-danger'>[LSystem]: " + error + "</div>";
                        return;
                    }

                    var st = new SilentTurtle();
                    st.processWord(l.out, this.alpha);

                    this.silentTurtleOut = ""
                    var points = st.points;
                    for (let index = 0; index < points.length - 1; index++) {
                        const e = points[index];
                        //console.log(e);
                        this.silentTurtleOut += "(" + e[0] + "," + e[1] + "), "
                    }

                    this.silentTurtleOut += "(" +
                        points[points.length - 1][0] + "," +
                        points[points.length - 1][1] + ")";

                    this.silentTurtleOut = st.points;
                },
                calcDimension: function () {
                    var l1 = new LSystem();
                    l1.V = this.V;
                    l1.E = this.E;
                    l1.Axiom = this.A;
                    l1.P = this.P;
                    l1.n = 9;
                    l1.generate();

                    var l2 = new LSystem();
                    l2.V = this.V;
                    l2.E = this.E;
                    l2.Axiom = this.A;
                    l2.P = this.P;
                    l2.n = 10;
                    l2.generate();

                    var t1 = new SilentTurtle();
                    t1.processWord(l1.out, this.alpha);

                    var t2 = new SilentTurtle();
                    t2.processWord(l2.out, this.alpha);

                    var A = t1.points
                    var B = t2.points

                    var iterationDelta = Math.abs(l2.n - l1.n);

                    var centerA = Math.sqrt(Math.pow(t1.bounds.xAverage, 2) + Math.pow(t1.bounds.yAverage, 2));
                    var centerB = Math.sqrt(Math.pow(t2.bounds.xAverage, 2) + Math.pow(t2.bounds.yAverage, 2));

                    var scaleFactor = Math.round(Math.pow(centerB / centerA, 1 / iterationDelta) * 100) / 100;
                    var N = Math.round(Math.pow(B.length / A.length, 1 / iterationDelta) * 100) / 100;

                    var dim = Math.round(Math.log(N) / Math.log(scaleFactor) * 100) / 100;

                    this.selfSimilarityCopies = N;
                    this.selfSimilarityScaleFactor = scaleFactor;
                    this.selfSimilarityDim = dim;
                },

                calcBoxDimension: function () {

                    var l = new LSystem();
                    l.V = this.V;
                    l.E = this.E;
                    l.Axiom = this.A;
                    l.P = this.P;
                    l.n = 5;
                    l.generate();

                    var width = 100;
                    var height = 100;
                    var resolution = width * height;

                    var t = new Turtle(width, height, this.alpha);
                    t.computeWord(l.out);

                    var img = t.finalContext.getImageData(0, 0, width, height);
                    var pixelCounter = 0;
                    for (let i = 0; i < resolution * 4; i += 4) {
                        console.log(img.data[i] + "/" + img.data[i + 1] + "/" + img.data[i + 2] + "/" + img.data[i + 3]);
                        if (img.data[i] != 0)
                            pixelCounter++;
                    }

                    console.log("Resolution:    " + resolution);
                    console.log("Pixel Counter: " + pixelCounter);

                    this.boxDimension = Math.log(pixelCounter) / Math.log(resolution);
                }
            }
        });

        var canvas = document.getElementById("screen");

        var preProcessingCanvas = document.getElementById("screenPostProcessing");

        if (canvas && canvas.getContext) {
            app.ctx = canvas.getContext('2d');

            if (preProcessingCanvas && preProcessingCanvas.getContext) {
                app.preProcesssingCtx = preProcessingCanvas.getContext('2d');

                // Create First Fractal on pageload
                app.generate();

            }
            else
                console.log("Pre-Processing Canvas Error");
        }
        else {
            console.log("Canvas error.");
        }



    </script>
    <div class='footer'>
        &copy; 2018 <a href='https://raphaelpour.de'>Raphael Pour</a> | <a href='https://bitbucket.org/evilc00kie/l-systems'>Source
            Code</a> licensed under
        <a href='http://www.gnu.de/documents/gpl.de.html'>GPL</a> | <a href='https://raphaelpour.de/impressum/'>Impressum</a>
    </div>
</body>

</html>